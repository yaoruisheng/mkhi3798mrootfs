name: Build Debian ARM Root Filesystems (Matrix Parallel)

on:
  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

jobs:
  # ====================================================================
  # JOB 1: å¹¶è¡Œæ„å»ºæ‰€æœ‰æ¶æ„ RootFS
  # ====================================================================
  build_rootfs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    # æ ¸å¿ƒï¼šå®šä¹‰å¹¶è¡ŒçŸ©é˜µ
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            qemu_binary: qemu-aarch64-static
          - arch: armhf
            qemu_binary: qemu-arm-static
          - arch: armel
            qemu_binary: qemu-arm-static

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Install dependencies (debootstrap + QEMU)
        run: |
          sudo apt-get update
          sudo apt-get install -y debootstrap tar curl wget qemu-user-static

      - name: 3. Build Debian ${{ matrix.arch }} rootfs (Stage 1)
        env:
          ROOTFS_DIR: ${{ github.workspace }}/debian_${{ matrix.arch }}
        run: |
          mkdir -p "$ROOTFS_DIR"

          # Stage 1: ä¸‹è½½å’Œæå–åŒ…ï¼ˆåŒ…å«æ‰€æœ‰å¿…éœ€çš„ sysvinit æ ¸å¿ƒç»„ä»¶å’Œå·¥å…·ï¼‰
          sudo debootstrap --verbose --arch=${{ matrix.arch }} \
            --include=dropbear,nano,wget,curl,locales \
            --foreign \
            stretch "$ROOTFS_DIR" http://mirrors.aliyun.com/debian-archive/debian

          # DNS é…ç½®
          echo -e "nameserver 8.8.8.8\nnameserver 8.8.4.4" | sudo tee "$ROOTFS_DIR/etc/resolv.conf"

          # Sources.list
          echo "deb http://mirrors.aliyun.com/debian-archive/debian stretch main contrib non-free non-free-firmware" \
            | sudo tee "$ROOTFS_DIR/etc/apt/sources.list"

      - name: 4. Run Stage 2 inside chroot (via QEMU) & Configure System âš™ï¸
        env:
          ROOTFS_DIR: ${{ github.workspace }}/debian_${{ matrix.arch }}
        run: |
          # å¤åˆ¶ QEMU äºŒè¿›åˆ¶æ–‡ä»¶åˆ°ç›®æ ‡ç³»ç»Ÿ
          sudo cp /usr/bin/${{ matrix.qemu_binary }} "$ROOTFS_DIR/usr/bin/"

          # æŒ‚è½½å¿…éœ€çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ (chroot å‰)
          sudo mount -t proc /proc "$ROOTFS_DIR/proc"
          sudo mount --rbind /sys "$ROOTFS_DIR/sys"
          sudo mount --rbind /dev "$ROOTFS_DIR/dev"

          # Stage 2: å®ŒæˆåŒ…é…ç½®
          sudo chroot "$ROOTFS_DIR" /debootstrap/debootstrap --second-stage
          
          # ------------------------------------------------------------------
          # ğŸŒŸ è‡ªå®šä¹‰ç³»ç»Ÿé…ç½®
          # ------------------------------------------------------------------
          echo "--- Running custom configurations inside chroot ---"
          
          # 1. è®¾ç½® root åˆå§‹å¯†ç ä¸º 'debian888'
          sudo chroot "$ROOTFS_DIR" sh -c 'echo "root:debian888" | chpasswd'
                    
          # 2. ç”Ÿæˆ Locales (æ”¯æŒä¸­æ–‡å’Œ UTF-8)
          sudo chroot "$ROOTFS_DIR" /bin/bash -c '
            echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
            echo "zh_CN.UTF-8 UTF-8" >> /etc/locale.gen
            locale-gen
            update-locale LANG=en_US.UTF-8
          '

          # ------------------------------------------------------------------
          # 3. é…ç½® Chrony NTP æœåŠ¡å™¨ (æ–°å¢/ä¿®æ”¹)
          # ------------------------------------------------------------------
          
          # 5a. æ³¨é‡Šæ‰æ‰€æœ‰é»˜è®¤çš„ NTP pool å’Œ server
          # ğŸ¯ é‡‡ç”¨æœ€é€šç”¨çš„æ–¹æ¡ˆï¼šåŒ¹é…è¡Œé¦–ï¼ˆå«ç©ºæ ¼/Tabï¼‰çš„ "pool" æˆ– "server" æŒ‡ä»¤ã€‚
          # åŒ¹é…å¹¶æ³¨é‡Šæ‰æ‰€æœ‰ä»¥ "pool" å¼€å¤´ä¸”å‰é¢å¯æœ‰ç©ºæ ¼çš„è¡Œ
          sudo sed -i '/^[[:space:]]*pool/s/^/#/' "$ROOTFS_DIR/etc/chrony/chrony.conf"
          # åŒ¹é…å¹¶æ³¨é‡Šæ‰æ‰€æœ‰ä»¥ "server" å¼€å¤´ä¸”å‰é¢å¯æœ‰ç©ºæ ¼çš„è¡Œ
          sudo sed -i '/^[[:space:]]*server/s/^/#/' "$ROOTFS_DIR/etc/chrony/chrony.conf"

          # 5b. åˆ›å»º tencent.conf å¹¶å†™å…¥é…ç½®
          # æ–°å¢çš„è…¾è®¯ NTP æœåŠ¡å™¨é…ç½®
          sudo chroot "$ROOTFS_DIR" /bin/bash -c '
            mkdir -p /etc/chrony/conf.d
            echo "server ntp.tencent.com iburst" > /etc/chrony/conf.d/tencent.conf
            echo "server ntp1.tencent.com iburst" >> /etc/chrony/conf.d/tencent.conf
            echo "server ntp2.tencent.com iburst" >> /etc/chrony/conf.d/tencent.conf
            echo "server ntp3.tencent.com iburst" >> /etc/chrony/conf.d/tencent.conf
            echo "server ntp4.tencent.com iburst" >> /etc/chrony/conf.d/tencent.conf
            echo "server ntp5.tencent.com iburst" >> /etc/chrony/conf.d/tencent.conf
          '
          
          echo "--- Custom configurations finished ---"
          # ------------------------------------------------------------------
          
          # ------------------------------------------------------------------
          # ğŸ§¹ æ¸…ç† APT ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶ (æ¶ˆé™¤éç¡®å®šæ€§å’Œå‡å°ä½“ç§¯)
          # ------------------------------------------------------------------
          echo "--- Cleaning up APT cache and temporary files ---"
          sudo chroot "$ROOTFS_DIR" /bin/bash -c '
            apt-get clean
            rm -rf /var/log/*
            rm -rf /tmp/*
          '

          # å¸è½½è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ (chroot å)
          sudo umount -lf "$ROOTFS_DIR/proc" || true
          sudo umount -lf "$ROOTFS_DIR/sys" || true
          sudo umount -lf "$ROOTFS_DIR/dev" || true

      - name: 5. Cleanup & Pack RootFS
        id: tar
        env:
          ROOTFS_DIR: ${{ github.workspace }}/debian_${{ matrix.arch }}
        run: |
          # æ¸…ç† QEMU äºŒè¿›åˆ¶æ–‡ä»¶
          sudo rm "$ROOTFS_DIR/usr/bin/${{ matrix.qemu_binary }}"

          # æ‰“åŒ…
          TARBALL_NAME=debian-${{ matrix.arch }}-rootfs.tar.gz
          sudo tar -czf "$TARBALL_NAME" -C "$ROOTFS_DIR" .

          echo "TARBALL_NAME=$TARBALL_NAME" >> $GITHUB_OUTPUT

      - name: 6. Upload RootFS Artifact
        uses: actions/upload-artifact@v4
        with:
          # æ¯ä¸ªæ¶æ„ä¸Šä¼ ä¸€ä¸ªç‹¬ç«‹çš„ Artifact
          name: debian-rootfs-${{ matrix.arch }}
          path: ${{ steps.tar.outputs.TARBALL_NAME }}

  # ====================================================================
  # JOB 2: åˆ›å»º Releaseï¼ˆæ”¶é›†æ‰€æœ‰ Artifactsï¼‰
  # ====================================================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build_rootfs
    permissions:
      contents: write

    steps:
      - name: 1. Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release_artifacts

      - name: 2. Flatten artifact directories
        run: |
          find ./release_artifacts -name "*.tar.gz" -exec mv {} ./release_artifacts/ \;
          find ./release_artifacts -type d -empty -delete
          ls -lh ./release_artifacts

      - name: 3. Generate release tag
        id: date
        run: echo "RELEASE_TAG=v$(date +'%Y.%m.%d').${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: 4. Create GitHub Release + upload assets
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.date.outputs.RELEASE_TAG }}
          name: Debian ARM RootFS Build ${{ steps.date.outputs.RELEASE_TAG }}
          body: |
            ## ğŸš€ è‡ªåŠ¨ç”Ÿæˆçš„ Debian ARM Root Filesystem

            åŒ…å«ä»¥ä¸‹æ¶æ„çš„æœ€å°åŒ– RootFSï¼š

            - **ARM64**ï¼ˆaarch64ï¼‰
            - **ARMHF**ï¼ˆarmv7 ç¡¬æµ®ç‚¹ï¼‰
            - **ARMEL**ï¼ˆarmv5/armv6 è½¯æµ®ç‚¹ï¼‰

            **ç³»ç»Ÿé…ç½®è¦ç‚¹:**
            - **Root åˆå§‹å¯†ç ï¼šdebian888** ğŸš¨ (è¯·åœ¨é¦–æ¬¡ç™»å½•åç«‹å³ä¿®æ”¹!)
          files: ./release_artifacts/*.tar.gz
